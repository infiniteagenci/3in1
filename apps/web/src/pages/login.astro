---
// src/pages/login.astro
// Login page with Google OAuth authentication
import Layout from '../layouts/Layout.astro'
---

<Layout title="Login - 3in1 Catholic Spiritual App">
  <div class="login-bg">
    <!-- Background elements -->
    <div class="login-bg-animation"></div>
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>

    <!-- Loading state -->
    <div id="loading" class="loading hidden">
      <div class="loading-spinner"></div>
      Checking authentication...
    </div>

    <!-- Login container -->
    <div class="login-container">
      <!-- Login form -->
      <div id="login-card" class="login-card hidden">
        <!-- Welcome section -->
        <div class="welcome-section">
          <h2 class="welcome-title">Find Peace & Connection<br>Through Meaningful Conversation</h2>
          <p class="welcome-description">
            Spirit is your warm, friendly guide for exploring faith, finding encouragement, and discovering the beauty of Catholic wisdom at your own pace.
          </p>
        </div>

        <!-- Google login button -->
        <button id="google-login-btn" class="google-btn">
          <svg class="google-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25C22.56 11.47 22.49 10.72 22.36 10H12V14.26H17.92C17.66 15.63 16.88 16.79 15.71 17.57V20.34H19.28C21.36 18.42 22.56 15.6 22.56 12.25Z" fill="#4285F4"/>
            <path d="M12 23C14.97 23 17.46 22.02 19.28 20.34L15.71 17.57C14.73 18.23 13.48 18.64 12 18.64C9.14 18.64 6.73 16.69 5.85 14.09H2.19V16.91C4.04 20.53 7.72 23 12 23Z" fill="#34A853"/>
            <path d="M5.85 14.09C5.62 13.38 5.49 12.63 5.49 11.87C5.49 11.11 5.62 10.36 5.85 9.65V6.83H2.19C1.43 8.28 1 9.96 1 11.87C1 13.78 1.43 15.46 2.19 16.91L5.85 14.09Z" fill="#FBBC05"/>
            <path d="M12 5.38C13.92 5.38 15.61 6.08 16.94 7.45L20.36 3.84C18.22 1.82 15.26 0.5 12 0.5C7.72 0.5 4.04 2.97 2.19 6.59L5.85 9.65C6.73 6.95 9.14 5.38 12 5.38Z" fill="#EA4335"/>
          </svg>
          Sign in with Google
        </button>

        <!-- Divider -->
        <div class="divider">
          <span class="divider-text">Spirit is here to help with</span>
        </div>

        <!-- Features section -->
        <div class="features-section">
          <h3 class="features-title">Friendly Faith Support</h3>
          <div class="features-list">
            <div class="feature-item">
              <div class="feature-icon">ðŸ’¬</div>
              <span class="feature-text">Warm conversations about faith and life</span>
            </div>
            <div class="feature-item">
              <div class="feature-icon">âœ¨</div>
              <span class="feature-text">Insights from Scripture & Catholic wisdom</span>
            </div>
            <div class="feature-item">
              <div class="feature-icon">ðŸ¤—</div>
              <span class="feature-text">A caring friend on your spiritual journey</span>
            </div>
          </div>
        </div>
      </div>

      <!-- User info (when logged in) -->
      <div id="user-card" class="login-card hidden">
        <div class="user-info-section">
          <div class="avatar">
            <img id="avatar" src="" alt="Avatar" />
          </div>
          <h2 class="welcome-back" id="welcome-text">Welcome back!</h2>
          <p class="user-email" id="user-email"></p>
          <a href="/chat" class="chat-btn">Continue Chatting with Spirit</a>
          <button id="logout-btn" class="logout-btn">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Login page client-side logic
     * Handles authentication state, login/logout, and OAuth callbacks
     */

    // ===== Configuration =====
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_URL = isLocalhost ? 'http://localhost:8788' : 'https://3in1-worker.ailabs-hq.workers.dev';
    const SESSION_TOKEN_KEY = 'session_token';

    // ===== DOM Elements =====
    const elements = {
      loading: document.getElementById('loading'),
      loginCard: document.getElementById('login-card'),
      userCard: document.getElementById('user-card'),
      googleLoginBtn: document.getElementById('google-login-btn'),
      logoutBtn: document.getElementById('logout-btn'),
      avatar: document.getElementById('avatar'),
      welcomeText: document.getElementById('welcome-text'),
      userEmail: document.getElementById('user-email'),
    };

    // ===== UI State Management =====
    const uiState = {
      hide(el: HTMLElement | null) {
        el?.classList.add('hidden');
      },

      show(el: HTMLElement | null) {
        el?.classList.remove('hidden');
      },

      showLoading() {
        this.show(elements.loading);
        this.hide(elements.loginCard);
        this.hide(elements.userCard);
      },

      showLogin() {
        this.hide(elements.loading);
        this.show(elements.loginCard);
        this.hide(elements.userCard);
      },

      showUser() {
        this.hide(elements.loading);
        this.hide(elements.loginCard);
        this.show(elements.userCard);
      },

      updateUser(user: { name: string; email: string; avatar_url?: string }) {
        if (user.avatar_url) {
          elements.avatar!.src = user.avatar_url;
          elements.avatar!.style.display = 'block';
          (elements.avatar!.parentElement as HTMLElement).textContent = '';
        } else {
          elements.avatar!.style.display = 'none';
          const parentDiv = elements.avatar!.parentElement as HTMLElement;
          parentDiv.classList.add('avatar');
          parentDiv.textContent = user.name?.charAt(0).toUpperCase() || 'U';
        }

        elements.welcomeText!.textContent = `Welcome, ${user.name}!`;
        elements.userEmail!.textContent = user.email;
      },
    };

    // ===== Authentication Functions =====
    const auth = {
      getToken(): string | null {
        return localStorage.getItem(SESSION_TOKEN_KEY);
      },

      setToken(token: string) {
        localStorage.setItem(SESSION_TOKEN_KEY, token);
      },

      removeToken() {
        localStorage.removeItem(SESSION_TOKEN_KEY);
      },

      async validateSession(): Promise<{ name: string; email: string; avatar_url?: string } | null> {
        const token = this.getToken();
        if (!token) return null;

        try {
          const response = await fetch(`${API_URL}/auth/validate`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
            this.removeToken();
            return null;
          }

          const data = await response.json();
          return data.user;
        } catch (error) {
          console.error('Error validating session:', error);
          this.removeToken();
          return null;
        }
      },

      async initiateLogin() {
        try {
          const response = await fetch(`${API_URL}/auth/google/url`);
          const { url } = await response.json();
          window.location.href = url;
        } catch (error) {
          console.error('Error initiating Google login:', error);
        }
      },

      async handleCallback(code: string): Promise<boolean> {
        try {
          const response = await fetch(`${API_URL}/auth/google/callback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code }),
          });

          const data = await response.json();

          if (data.session_token) {
            this.setToken(data.session_token);
            window.location.href = '/chat';
            return true;
          }

          return false;
        } catch (error) {
          console.error('Error exchanging code for token:', error);
          return false;
        }
      },

      async logout() {
        const token = this.getToken();

        if (token) {
          try {
            await fetch(`${API_URL}/auth/logout`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
            });
          } catch (error) {
            console.error('Error during logout:', error);
          }
        }

        this.removeToken();
        uiState.showLogin();
      },
    };

    // ===== Initialization =====
    async function init() {
      // Check for OAuth callback in URL
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        uiState.showLoading();

        // Clean URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);

        const success = await auth.handleCallback(code);
        if (!success) {
          uiState.showLogin();
        }
        return;
      }

      // Check existing session
      const user = await auth.validateSession();

      if (user) {
        uiState.updateUser(user);
        uiState.showUser();
      } else {
        uiState.showLogin();
      }
    }

    // ===== Event Listeners =====
    elements.googleLoginBtn?.addEventListener('click', () => auth.initiateLogin());
    elements.logoutBtn?.addEventListener('click', () => auth.logout());

    // ===== Start =====
    init();
  </script>
</Layout>
