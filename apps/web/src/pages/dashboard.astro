---
// src/pages/dashboard.astro

// Extract environment variable at build time/server-side
const { PUBLIC_WORKER_API_URL = 'http://localhost:8788' } = import.meta.env;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Chat with Spirit - 3in1 Spiritual App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
      .chat-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      /* Add animated background elements */
      .chat-container::before {
        content: '';
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 20% 80%, rgba(147, 51, 234, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.2) 0%, transparent 50%);
        animation: float 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes float {
        0%, 100% { transform: translate(-10%, -10%) rotate(0deg); }
        33% { transform: translate(10%, -10%) rotate(120deg); }
        66% { transform: translate(-10%, 10%) rotate(240deg); }
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 10;
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      @media (max-width: 640px) {
        .header {
          padding: 1rem;
        }

        .header-content {
          justify-content: center;
          text-align: center;
        }

        .user-info {
          width: 100%;
          justify-content: center;
        }
      }

      .app-title {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .user-info {
        color: white;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .chat-content {
        flex: 1;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        position: relative;
        z-index: 5;
      }

      @media (max-width: 640px) {
        .chat-content {
          padding: 0.75rem;
          gap: 0.75rem;
        }
      }

      .messages-container {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1.5rem;
        overflow-y: auto;
        min-height: 400px;
        max-height: 600px;
        scroll-behavior: smooth;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 640px) {
        .messages-container {
          padding: 1rem;
          min-height: calc(100vh - 250px);
          max-height: calc(100vh - 250px);
          border-radius: 0.75rem;
        }
      }

      /* Custom scrollbar */
      .messages-container::-webkit-scrollbar {
        width: 6px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        transition: background 0.3s;
      }

      .messages-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      .message {
        margin-bottom: 1.25rem;
        display: flex;
        gap: 0.75rem;
        animation: messageSlideIn 0.3s ease-out;
      }

      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.875rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s;
      }

      .message-avatar:hover {
        transform: scale(1.05);
      }

      .message.spirit .message-avatar {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(240, 147, 251, 0.4); }
        50% { box-shadow: 0 0 0 10px rgba(240, 147, 251, 0); }
      }

      .message-content {
        max-width: 70%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        color: #1f2937;
        line-height: 1.6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.2s;
      }

      .message-content:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .message.user .message-content {
        background: rgba(255, 255, 255, 0.98);
        border-top-right-radius: 0.25rem;
      }

      .message.spirit .message-content {
        background: rgba(255, 255, 255, 0.9);
        border-top-left-radius: 0.25rem;
      }

      @media (max-width: 640px) {
        .message {
          gap: 0.5rem;
          margin-bottom: 1rem;
        }

        .message-avatar {
          width: 32px;
          height: 32px;
          font-size: 0.75rem;
        }

        .message-content {
          max-width: 80%;
          padding: 0.875rem 1rem;
          font-size: 0.9rem;
        }
      }

      .message-timestamp {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
      }

      .input-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        position: sticky;
        bottom: 0;
        z-index: 10;
      }

      @media (max-width: 640px) {
        .input-container {
          padding: 0.75rem;
          gap: 0.5rem;
          border-radius: 0.75rem;
        }
      }

      .message-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        font-size: 1rem;
        resize: none;
        max-height: 120px;
        min-height: 44px;
        font-family: inherit;
        line-height: 1.5;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .message-input:focus {
        outline: none;
        background: white;
        border-color: rgba(147, 51, 234, 0.3);
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }

      @media (max-width: 640px) {
        .message-input {
          padding: 0.75rem;
          font-size: 16px; /* Prevents zoom on iOS */
          min-height: 44px;
        }
      }

      .send-btn {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        color: white;
        border: none;
        padding: 0.875rem 1.5rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(240, 147, 251, 0.3);
        position: relative;
        overflow: hidden;
      }

      .send-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
      }

      .send-btn:hover::before {
        left: 100%;
      }

      .send-btn:active {
        transform: translateY(-1px);
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 640px) {
        .send-btn {
          padding: 0.75rem 1.25rem;
          font-size: 0.9rem;
        }
      }

      .loading, .error {
        text-align: center;
        padding: 2rem;
        color: white;
        font-size: 1.1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .loading {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        margin: 2rem auto;
        max-width: 400px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .loading::before {
        content: 'üôè';
        font-size: 2rem;
        animation: float 3s ease-in-out infinite;
      }

      .error {
        background: rgba(239, 68, 68, 0.1);
        border-radius: 1rem;
        margin: 2rem auto;
        max-width: 400px;
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .error::before {
        content: '‚ö†Ô∏è';
        font-size: 2rem;
      }

      .typing-indicator {
        color: rgba(255, 255, 255, 0.9);
        font-style: italic;
        font-size: 0.875rem;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        border-left: 3px solid rgba(240, 147, 251, 0.5);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .typing-dots {
        display: inline-flex;
        gap: 4px;
        margin-left: 8px;
      }

      .typing-dots span {
        width: 6px;
        height: 6px;
        background: rgba(240, 147, 251, 0.7);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%, 60%, 100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      /* Add haptic feedback on mobile */
      @media (hover: none) and (pointer: coarse) {
        .send-btn:active,
        .message-avatar:active,
        .logout-btn:active {
          -webkit-tap-highlight-color: transparent;
        }
      }
    </style>
  </head>
  <body>
    <div className="chat-container">
      <header className="header">
        <div className="header-content">
          <div className="app-title">
            <div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
            <span>3in1</span>
          </div>
          <div className="user-info">
            <span id="user-name">Loading...</span>
            <button id="logout-btn" className="logout-btn">Logout</button>
          </div>
        </div>
      </header>

      <div className="chat-content">
        <div id="loading" className="loading">Loading your conversation with Spirit...</div>
        <div id="error" className="error hidden">Failed to load conversation. Please try again.</div>
        <div id="chat-main" className="hidden">
          <div className="messages-container" id="messages-container">
            <div className="message spirit">
              <div className="message-avatar">üôè</div>
              <div className="message-content">
                <div>Peace be with you! I'm Spirit, here to walk with you on your spiritual journey. I'm here to listen, guide you based on Jesus's teachings, and help you grow in faith. What's on your heart today?</div>
                <div className="message-timestamp">Just now</div>
              </div>
            </div>
          </div>
          <div className="input-container">
            <textarea
              id="message-input"
              className="message-input"
              placeholder="Share what's on your heart..."
              rows="1"
            ></textarea>
            <button id="send-btn" className="send-btn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script define:vars={{PUBLIC_WORKER_API_URL: import.meta.env.PUBLIC_WORKER_API_URL}}>
      // DOM elements
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const mainEl = document.getElementById('chat-main');
      const logoutBtn = document.getElementById('logout-btn');
      const userNameEl = document.getElementById('user-name');
      const messagesContainer = document.getElementById('messages-container');
      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');

      let currentConversationId = null;

      // Function to add hidden class
      function hideElement(el) {
        el.classList.add('hidden');
      }

      // Function to remove hidden class
      function showElement(el) {
        el.classList.remove('hidden');
      }

      // Function to create timestamp
      function formatTimestamp() {
        const now = new Date();
        return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Function to add message to chat with enhanced features
      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'spirit'}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = isUser ? 'üë§' : 'üôè';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const messageText = document.createElement('div');
        messageText.textContent = content;

        // Add subtle animation for messages
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';

        const timestamp = document.createElement('div');
        timestamp.className = 'message-timestamp';
        timestamp.textContent = formatTimestamp();

        messageContent.appendChild(messageText);
        messageContent.appendChild(timestamp);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        messagesContainer.appendChild(messageDiv);

        // Smooth scroll to bottom with animation
        setTimeout(() => {
          messageDiv.style.transition = 'all 0.3s ease-out';
          messageDiv.style.opacity = '1';
          messageDiv.style.transform = 'translateY(0)';

          // Smooth scroll with easing
          const scrollOptions = {
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
          };
          messagesContainer.scrollTo(scrollOptions);
        }, 50);

        // Add haptic feedback on mobile if available
        if (navigator.vibrate && !isUser) {
          navigator.vibrate(50);
        }
      }

      // Function to show typing indicator
      function showTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'message spirit';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = 'üôè';

        const typingContent = document.createElement('div');
        typingContent.className = 'typing-indicator';
        typingContent.innerHTML = 'Spirit is thinking<div class="typing-dots"><span></span><span></span><span></span></div>';

        typingDiv.appendChild(avatar);
        typingDiv.appendChild(typingContent);

        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Function to remove typing indicator
      function removeTyping() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Function to send message with streaming
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        const token = localStorage.getItem('session_token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        // Add user message to chat
        addMessage(message, true);

        // Clear input and disable send button
        messageInput.value = '';
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';

        // Show typing indicator
        showTyping();

        try {
          const eventSource = new EventSource(PUBLIC_WORKER_API_URL + '/api/chat/stream');
          let spiritMessageElement = null;
          let spiritMessageText = '';

          // Send the message via fetch first
          const response = await fetch(PUBLIC_WORKER_API_URL + '/api/chat/stream', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: message,
              conversationId: currentConversationId
            })
          });

          if (!response.ok) {
            throw new Error('Failed to send message');
          }

          // Handle the streaming response
          const reader = response.body?.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          if (reader) {
            // Remove typing indicator
            removeTyping();

            // Create Spirit message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message spirit';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'üôè';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const messageText = document.createElement('div');
            messageText.textContent = '';

            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            timestamp.textContent = formatTimestamp();

            messageContent.appendChild(messageText);
            messageContent.appendChild(timestamp);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            messagesContainer.appendChild(messageDiv);
            spiritMessageElement = messageText;

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  try {
                    const parsed = JSON.parse(data);

                    if (parsed.conversation_id) {
                      currentConversationId = parsed.conversation_id;
                    } else if (parsed.chunk) {
                      spiritMessageText += parsed.chunk;
                      if (spiritMessageElement) {
                        spiritMessageElement.textContent = spiritMessageText;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                      }
                    } else if (parsed.complete) {
                      // Stream completed
                      sendBtn.disabled = false;
                      sendBtn.textContent = 'Send';
                      messageInput.focus();
                    } else if (parsed.error) {
                      throw new Error(parsed.error);
                    }
                  } catch (e) {
                    // Ignore parse errors
                  }
                }
              }
            }
          }

        } catch (error) {
          console.error('Error sending message:', error);
          removeTyping();
          addMessage("I'm having trouble connecting right now, but I'm here for you. Please try again in a moment.", false);
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send';
          messageInput.focus();
        }
      }

      // Function to handle logout
      async function logout() {
        try {
          const token = localStorage.getItem('session_token');
          if (token) {
            await fetch(PUBLIC_WORKER_API_URL + '/auth/logout', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
          }

          localStorage.removeItem('session_token');
          window.location.href = '/login';
        } catch (error) {
          console.error('Error logging out:', error);
        }
      }

      // Function to initialize user data
      async function initializeUser() {
        try {
          const token = localStorage.getItem('session_token');
          if (!token) {
            window.location.href = '/login';
            return;
          }

          const response = await fetch(PUBLIC_WORKER_API_URL + '/auth/validate', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });

          if (response.ok) {
            const { user } = await response.json();
            userNameEl.textContent = user.name;

            // Show chat interface
            hideElement(loadingEl);
            hideElement(errorEl);
            showElement(mainEl);
          } else {
            localStorage.removeItem('session_token');
            window.location.href = '/login';
          }
        } catch (err) {
          console.error('Error fetching user:', err);
          hideElement(loadingEl);
          showElement(errorEl);
          hideElement(mainEl);
        }
      }

      // Event listeners
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      });

      logoutBtn.addEventListener('click', logout);

      // Initialize on page load
      initializeUser();
      messageInput.focus();
    </script>
  </body>
</html>