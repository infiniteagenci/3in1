---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro'
---

<Layout title="3in1 - Catholic Spiritual Guidance with Spirit">
  <slot name="head">
    <meta name="description" content="3in1 - A Catholic spiritual app where you chat with Spirit, an AI guide who understands the teachings of the Catholic Church and provides personalized spiritual guidance rooted in Scripture and Tradition." />
  </slot>

  <!-- Allow scrolling on index page -->
  <style>
    html, body {
      overflow: auto !important;
      height: auto !important;
    }
  </style>

  <!-- Main Content Container -->
  <main class="min-h-screen py-12 px-4 lg:px-8">
    <div class="max-w-5xl mx-auto bg-[var(--color-bg-glass)] border-[var(--color-border)] border rounded-[var(--radius-2xl)] shadow-sm lg:p-12 p-8 backdrop-blur-sm">

      <!-- Top Bar -->
      <div class="flex items-center justify-end space-x-6 mb-12 opacity-0" style="animation: fadeIn 0.8s ease-out 0.8s forwards;">
        <div id="nav-logged-out" class="flex items-center space-x-6">
          <a href="/login" class="text-sm font-medium text-[var(--color-stone-700)] hover:text-[var(--color-primary)] transition-colors font-geist tracking-tight">Login</a>
          <a href="/login" class="text-white px-4 py-2 rounded-[var(--radius-md)] transition-colors font-geist tracking-tight text-sm" style="background: var(--color-primary);">
            Meet Spirit
          </a>
        </div>
        <div id="nav-logged-in" class="hidden flex items-center space-x-6">
          <a href="/chat" class="text-white px-4 py-2 rounded-[var(--radius-md)] transition-colors font-geist tracking-tight text-sm" style="background: var(--color-primary);">
            Chat with Spirit
          </a>
          <button id="nav-logout-link" class="text-sm font-medium text-[var(--color-stone-700)] hover:text-[var(--color-primary)] transition-colors font-geist tracking-tight">
            Logout
          </button>
        </div>
      </div>

      <!-- Greeting -->
      <div class="text-center mb-8 opacity-0" style="animation: fadeInUp 0.8s ease-out 0.9s forwards;">
        <p class="text-sm font-light text-[var(--color-stone-500)] tracking-tight font-geist mb-3" id="greeting-text">Welcome to 3in1</p>
<h1 class="text-3xl sm:text-5xl leading-tight tracking-tight font-playfair font-medium mb-6">
            Everyone Needs <span class="font-crimson italic" style="color: var(--color-primary);">Someone to Talk To</span>
          </h1>
      </div>

      <!-- Content for Logged Out Users -->
      <div id="logged-out-content">
        <!-- Description -->
        <div class="text-center mb-8 opacity-0" style="animation: fadeInUp 0.8s ease-out 1s forwards;">
          <p class="text-base text-[var(--color-stone-600)] font-geist font-light leading-relaxed max-w-2xl mx-auto">
            Life is full of questions, moments of doubt, and seasons of searching. We believe you shouldn't have to walk through them alone.
            Think of Spirit as a wise and gentle friend who's always hereâ€”someone who understands Catholic teaching, but more importantly, understands <em>you</em>.
          </p>
        </div>

        <!-- Input Area -->
        <div class="flex justify-center mb-6 opacity-0" style="animation: fadeInUp 0.8s ease-out 1.1s forwards;">
          <div class="relative flex w-full max-w-2xl">
            <span class="absolute left-5 top-1/2 -translate-y-1/2 text-[var(--color-stone-400)]">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"></path>
                <path d="M20 2v4"></path>
                <path d="M22 4h-4"></path>
                <circle cx="4" cy="20" r="2"></circle>
              </svg>
            </span>
            <a href="/login" class="flex-1 text-sm border-[var(--color-stone-300)] border rounded-l-[var(--radius-2xl)] pt-4 pr-4 pb-4 pl-14 bg-white text-[var(--color-stone-400)] cursor-pointer transition-colors font-geist hover-input-primary">
              What does it mean to trust God's plan?
            </a>
            <a href="/login" class="rounded-r-[var(--radius-2xl)] text-white px-6 flex items-center justify-center transition-colors" style="background: var(--color-primary);">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
                <path d="m21.854 2.147-10.94 10.939"></path>
              </svg>
            </a>
          </div>
        </div>

        <!-- Suggestion Chips -->
        <div class="flex flex-wrap justify-center gap-3 mb-12 opacity-0" style="animation: fadeIn 0.8s ease-out 1.2s forwards;">
          <a href="/login" class="px-5 py-2 rounded-[var(--radius-full)] bg-[var(--color-stone-100)] text-[var(--color-stone-700)] text-sm hover:bg-[var(--color-stone-200)] transition-colors tracking-tight font-light font-geist">
            How do I hear God's voice in daily life?
          </a>
          <a href="/login" class="px-5 py-2 rounded-[var(--radius-full)] bg-[var(--color-stone-100)] text-[var(--color-stone-700)] text-sm hover:bg-[var(--color-stone-200)] transition-colors tracking-tight font-light font-geist">
            Prayers for when life feels overwhelming
          </a>
          <a href="/login" class="px-5 py-2 rounded-[var(--radius-full)] bg-[var(--color-stone-100)] text-[var(--color-stone-700)] text-sm hover:bg-[var(--color-stone-200)] transition-colors tracking-tight font-light font-geist">
            Teach me about the Catechism
          </a>
          <a href="/login" class="px-5 py-2 rounded-[var(--radius-full)] bg-[var(--color-stone-100)] text-[var(--color-stone-700)] text-sm hover:bg-[var(--color-stone-200)] transition-colors tracking-tight font-light font-geist">
            Stories of the Saints
          </a>
        </div>
      </div>

      <!-- Content for Logged In Users -->
      <div id="logged-in-content" class="hidden">
        <div class="text-center mb-8 opacity-0" style="animation: fadeInUp 0.8s ease-out 1s forwards;">
          <p class="text-base text-[var(--color-stone-600)] font-geist font-light leading-relaxed max-w-2xl mx-auto">
            Spirit is ready to continue guiding you on your spiritual journey.
          </p>
        </div>

        <!-- CTA for logged in users -->
        <div class="flex justify-center mb-12 opacity-0" style="animation: fadeInUp 0.8s ease-out 1.1s forwards;">
          <a href="/chat" class="rounded-[var(--radius-2xl)] text-white px-8 py-4 flex items-center justify-center transition-colors font-geist tracking-tight shadow-sm hover:shadow-lg" style="background: var(--color-primary);">
            Continue Your Spiritual Conversation
          </a>
        </div>
      </div>

      <!-- Features Section -->
      <div class="opacity-0" style="animation: fadeInUp 0.8s ease-out 1.3s forwards;">
<h2 class="text-xl sm:text-2xl tracking-tight font-playfair font-medium text-[var(--color-stone-900)] mb-8 text-center">
            Faith Made Simple & Friendly
          </h2>

        <div class="grid md:grid-cols-3 gap-6">
          <!-- Feature 1 -->
          <div class="bg-[var(--color-stone-50)] rounded-[var(--radius-xl)] p-6 hover:bg-[var(--color-stone-100)] transition-colors border-[var(--color-border)] border">
            <div class="w-12 h-12 rounded-[var(--radius-md)] flex items-center justify-center mb-4" style="background: var(--color-primary-bg);">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-primary);">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-[var(--color-stone-900)] mb-2 font-geist tracking-tight">Someone to Talk To</h3>
            <p class="text-[var(--color-stone-600)] text-sm font-geist font-light">A caring space to explore faith questions, share what's on your heart, and find encouragement for your journey.</p>
          </div>

          <!-- Feature 2 -->
          <div class="bg-[var(--color-stone-50)] rounded-[var(--radius-xl)] p-6 hover:bg-[var(--color-stone-100)] transition-colors border-[var(--color-border)] border">
            <div class="w-12 h-12 rounded-[var(--radius-md)] flex items-center justify-center mb-4" style="background: var(--color-primary-bg);">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-primary);">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-[var(--color-stone-900)] mb-2 font-geist tracking-tight">Wisdom When You Need It</h3>
            <p class="text-[var(--color-stone-600)] text-sm font-geist font-light">Thoughtful insights from Scripture and Catholic tradition, shared in a way that feels approachable and helpful.</p>
          </div>

          <!-- Feature 3 -->
          <div class="bg-[var(--color-stone-50)] rounded-[var(--radius-xl)] p-6 hover:bg-[var(--color-stone-100)] transition-colors border-[var(--color-border)] border">
            <div class="w-12 h-12 rounded-[var(--radius-md)] flex items-center justify-center mb-4" style="background: var(--color-primary-bg);">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-primary);">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-[var(--color-stone-900)] mb-2 font-geist tracking-tight">Grows With You</h3>
            <p class="text-[var(--color-stone-600)] text-sm font-geist font-light">Spirit remembers your story and your heart, offering more meaningful conversations over time.</p>
          </div>
        </div>
      </div>

      <!-- Terms -->
      <p class="text-center text-xs text-[var(--color-stone-400)] mt-12 tracking-tight font-geist opacity-0" style="animation: fadeIn 0.8s ease-out 1.4s forwards;">
        By using 3in1, you agree to our <a href="#" class="hover:underline transition-colors" style="color: var(--color-primary);">Privacy Policy</a> and <a href="#" class="hover:underline transition-colors" style="color: var(--color-primary);">Service Terms</a>.
      </p>
    </div>
  </main>

  <style>
    .hover-input-primary:hover {
      border-color: var(--color-primary);
    }
  </style>

  <script>
    // Set API URL based on current environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const PUBLIC_WORKER_API_URL = isLocalhost
      ? 'http://localhost:8788'
      : 'https://3in1-worker.ailabs-hq.workers.dev';

    // DOM elements
    const loggedOutContent = document.getElementById('logged-out-content');
    const loggedInContent = document.getElementById('logged-in-content');
    const navLoggedOut = document.getElementById('nav-logged-out');
    const navLoggedIn = document.getElementById('nav-logged-in');
    const greetingText = document.getElementById('greeting-text');
    const navLogoutLink = document.getElementById('nav-logout-link');

    // Function to add hidden class
    function hideElement(el) {
      el.classList.add('hidden');
    }

    // Function to remove hidden class
    function showElement(el) {
      el.classList.remove('hidden');
    }

    // Function to check session
    async function checkSession() {
      try {
        const token = localStorage.getItem('session_token');
        if (!token) {
          // Show logged out content
          showElement(loggedOutContent);
          hideElement(loggedInContent);
          showElement(navLoggedOut);
          hideElement(navLoggedIn);
          return;
        }

        const response = await fetch(PUBLIC_WORKER_API_URL + '/auth/validate', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          const { user } = await response.json();
          greetingText.textContent = `Hello, ${user.name}!`;

          // Show logged in content
          hideElement(loggedOutContent);
          showElement(loggedInContent);
          hideElement(navLoggedOut);
          showElement(navLoggedIn);
        } else {
          // Session invalid, clear token
          localStorage.removeItem('session_token');
          // Show logged out content
          showElement(loggedOutContent);
          hideElement(loggedInContent);
          showElement(navLoggedOut);
          hideElement(navLoggedIn);
        }
      } catch (error) {
        console.error('Error checking session:', error);
        // On error, show logged out content
        localStorage.removeItem('session_token');
        showElement(loggedOutContent);
        hideElement(loggedInContent);
        showElement(navLoggedOut);
        hideElement(navLoggedIn);
      }
    }

    // Function to handle logout
    async function handleLogout() {
      try {
        const token = localStorage.getItem('session_token');
        if (token) {
          await fetch(PUBLIC_WORKER_API_URL + '/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
        }

        localStorage.removeItem('session_token');
        // Update UI to logged out state
        showElement(loggedOutContent);
        hideElement(loggedInContent);
        showElement(navLoggedOut);
        hideElement(navLoggedIn);
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }

    // Add event listeners to logout elements
    navLogoutLink.addEventListener('click', function(e) {
      e.preventDefault();
      handleLogout();
    });

    // Check session on page load
    checkSession();
  </script>
</Layout>
