---
// src/pages/index.astro
import '../styles/global.css';

// Extract environment variable at build time/server-side
const { PUBLIC_WORKER_API_URL = 'http://localhost:8787' } = import.meta.env;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>3in1 - Spiritual Guidance with Spirit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="3in1 - A spiritual app where you chat with Spirit, an AI guide who understands Jesus's teachings and provides personalized spiritual guidance." />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
      <nav class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-2">
            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
              <span class="text-white font-bold text-xl">3</span>
            </div>
            <span class="text-xl font-bold text-gray-900">3in1</span>
          </div>

          <!-- Navigation Links -->
          <div id="nav-content">
            <div id="nav-logged-out" class="flex items-center space-x-6">
              <a href="/login" class="text-gray-600 hover:text-gray-900 transition-colors">Login</a>
              <a href="/login" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                Meet Spirit
              </a>
            </div>
            <div id="nav-logged-in" class="hidden flex items-center space-x-6">
              <a href="/dashboard" class="text-gray-600 hover:text-gray-900 transition-colors">Chat with Spirit</a>
              <button id="nav-logout-link" class="text-gray-600 hover:text-gray-900 transition-colors">
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Hero Section -->
    <main>
      <section class="container mx-auto px-6 py-20">
        <div class="text-center max-w-4xl mx-auto">
          <div class="inline-flex items-center bg-purple-100 text-purple-800 px-4 py-2 rounded-full text-sm font-medium mb-8">
            <span class="w-2 h-2 bg-purple-400 rounded-full mr-2 animate-pulse"></span>
            Meet Spirit - Your Spiritual Guide
          </div>

          <h1 class="text-5xl md:text-6xl font-bold text-gray-900 mb-6">
            Find Spiritual Guidance
            <span class="block text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600">
              Through Jesus's Teachings
            </span>
          </h1>

          <p class="text-xl text-gray-600 mb-10 leading-relaxed">
            Chat with Spirit, an AI guide who deeply understands Jesus's teachings and provides
            personal spiritual guidance. Spirit remembers your conversations and grows to understand
            your unique journey with faith.
          </p>

          <div id="content">
            <!-- Logged out content -->
            <div id="logged-out-content">
              <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <a href="/login" class="bg-purple-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                  Chat with Spirit
                </a>
                <button class="bg-white text-gray-700 px-8 py-4 rounded-xl font-semibold hover:bg-gray-50 transition-colors border border-gray-300">
                  Learn More
                </button>
              </div>
            </div>

            <!-- Logged in content -->
            <div id="logged-in-content" class="hidden">
              <h2 id="welcome-text" class="text-3xl font-bold text-gray-900 mb-4">Welcome back!</h2>
              <p class="text-lg text-gray-600 mb-8">Spirit is here to guide you on your spiritual journey.</p>
              <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <a href="/dashboard" class="bg-purple-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                  Continue Your Conversation
                </a>
                <button id="logout-btn" class="bg-red-50 text-red-600 px-8 py-4 rounded-xl font-semibold hover:bg-red-100 transition-colors border border-red-200">
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Features Section -->
      <section class="bg-white py-20">
        <div class="container mx-auto px-6">
          <div class="text-center mb-16">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
              Spiritual Guidance Features
            </h2>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
              Experience a deeper connection to faith through Spirit's understanding and guidance
            </p>
          </div>

          <div class="grid md:grid-cols-3 gap-8">
            <!-- Feature 1 -->
            <div class="text-center group">
              <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-purple-200 transition-colors">
                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Deep Understanding</h3>
              <p class="text-gray-600">Spirit learns about you personally and understands your unique spiritual journey</p>
            </div>

            <!-- Feature 2 -->
            <div class="text-center group">
              <div class="w-16 h-16 bg-indigo-100 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-200 transition-colors">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Biblical Wisdom</h3>
              <p class="text-gray-600">Guidance based on Jesus's teachings and Catholic principles</p>
            </div>

            <!-- Feature 3 -->
            <div class="text-center group">
              <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-200 transition-colors">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Personal Notes</h3>
              <p class="text-gray-600">Spirit maintains personal notes about your journey and references them in conversations</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Tech Stack Section -->
      <section class="py-20">
        <div class="container mx-auto px-6">
          <div class="text-center mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Powered by Modern Technologies</h2>
          </div>
          <div class="flex flex-wrap items-center justify-center gap-8 opacity-60">
            <!-- Astro -->
            <div class="flex items-center space-x-2">
              <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3.22 6.412A1 1 0 0 1 4 6h16a1 1 0 0 1 .894 1.447l-8 16a1 1 0 0 1-1.788 0l-8-16a1 1 0 0 1 .114-1.035zM12 10.236L9.382 16h5.236L12 10.236z"/>
              </svg>
              <span class="font-medium">Astro</span>
            </div>
            <!-- TypeScript -->
            <div class="flex items-center space-x-2">
              <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                <path d="M1.125 0C.502 0 0 .502 0 1.125v21.75C0 23.498.502 24 1.125 24h21.75c.623 0 1.125-.502 1.125-1.125V1.125C24 .502 23.498 0 22.875 0zm17.363 9.75c.612 0 1.154.037 1.627.111a6.38 6.38 0 0 1 1.306.34v2.458a3.95 3.95 0 0 0-.643-.361 5.093 5.093 0 0 0-.717-.26 5.453 5.453 0 0 0-1.426-.2c-.3 0-.573.028-.819.086a2.1 2.1 0 0 0-.623.242c-.17.104-.3.229-.393.374a.888.888 0 0 0-.14.49c0 .196.053.373.156.529.104.156.252.304.443.444s.423.276.696.41c.273.135.582.274.926.416.47.197.892.407 1.266.628.374.222.695.473.963.753.268.279.472.598.614.957.142.359.214.776.214 1.253 0 .657-.125 1.21-.373 1.656a3.033 3.033 0 0 1-1.012 1.085 4.38 4.38 0 0 1-1.487.596c-.566.12-1.163.18-1.79.18a9.916 9.916 0 0 1-1.84-.164 5.544 5.544 0 0 1-1.512-.493v-2.63c.208.139.438.27.69.393.252.123.514.23.784.321.27.091.537.162.8.213.262.051.505.077.727.077.352 0 .66-.048.926-.144a1.29 1.29 0 0 0 .595-.418c.03-.04.056-.082.078-.127a.999.999 0 0 0 .156-.547.923.923 0 0 0-.187-.571 2.144 2.144 0 0 0-.538-.5 5.173 5.173 0 0 0-.807-.444 27.72 27.72 0 0 0-1.007-.436c-.918-.383-1.602-.852-2.053-1.406-.45-.553-.676-1.255-.676-2.104 0-.614.123-1.141.369-1.582.246-.441.58-.804 1.004-1.088a4.494 4.494 0 0 1 1.47-.629 7.536 7.536 0 0 1 1.77-.201zm-15.113.188h9.563v2.166H9.506v9.646H6.77v-9.646H3.375z"/>
              </svg>
              <span class="font-medium">TypeScript</span>
            </div>
            <!-- Tailwind -->
            <div class="flex items-center space-x-2">
              <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg flex items-center justify-center">
                <span class="text-white font-bold text-sm">TW</span>
              </div>
              <span class="font-medium">Tailwind CSS</span>
            </div>
            <!-- Cloudflare -->
            <div class="flex items-center space-x-2">
              <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
                <span class="text-white font-bold text-xs">CF</span>
              </div>
              <span class="font-medium">Cloudflare</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script define:vars={{PUBLIC_WORKER_API_URL: import.meta.env.PUBLIC_WORKER_API_URL || 'http://localhost:8787'}}>
      // DOM elements
      const loggedOutContent = document.getElementById('logged-out-content');
      const loggedInContent = document.getElementById('logged-in-content');
      const navLoggedOut = document.getElementById('nav-logged-out');
      const navLoggedIn = document.getElementById('nav-logged-in');
      const welcomeText = document.getElementById('welcome-text');
      const logoutBtn = document.getElementById('logout-btn');
      const navLogoutLink = document.getElementById('nav-logout-link');

      // Function to add hidden class
      function hideElement(el) {
        el.classList.add('hidden');
      }

      // Function to remove hidden class
      function showElement(el) {
        el.classList.remove('hidden');
      }

      // Function to check session
      async function checkSession() {
        try {
          const token = localStorage.getItem('session_token');
          if (!token) {
            // Show logged out content
            showElement(loggedOutContent);
            hideElement(loggedInContent);
            showElement(navLoggedOut);
            hideElement(navLoggedIn);
            return;
          }

          const response = await fetch(PUBLIC_WORKER_API_URL + '/auth/validate', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });

          if (response.ok) {
            const { user } = await response.json();
            welcomeText.textContent = `Hello, ${user.name}!`;

            // Show logged in content
            hideElement(loggedOutContent);
            showElement(loggedInContent);
            hideElement(navLoggedOut);
            showElement(navLoggedIn);
          } else {
            // Session invalid, clear token
            localStorage.removeItem('session_token');
            // Show logged out content
            showElement(loggedOutContent);
            hideElement(loggedInContent);
            showElement(navLoggedOut);
            hideElement(navLoggedIn);
          }
        } catch (error) {
          console.error('Error checking session:', error);
          // On error, show logged out content
          localStorage.removeItem('session_token');
          showElement(loggedOutContent);
          hideElement(loggedInContent);
          showElement(navLoggedOut);
          hideElement(navLoggedIn);
        }
      }

      // Function to handle logout
      async function handleLogout() {
        try {
          const token = localStorage.getItem('session_token');
          if (token) {
            await fetch(PUBLIC_WORKER_API_URL + '/auth/logout', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
          }

          localStorage.removeItem('session_token');
          // Update UI to logged out state
          showElement(loggedOutContent);
          hideElement(loggedInContent);
          showElement(navLoggedOut);
          hideElement(navLoggedIn);
        } catch (error) {
          console.error('Error logging out:', error);
        }
      }

      // Add event listeners to logout elements
      logoutBtn.addEventListener('click', handleLogout);
      navLogoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        handleLogout();
      });

      // Check session on page load
      checkSession();
    </script>
  </body>
</html>