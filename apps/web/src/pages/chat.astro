---
// src/pages/chat.astro
import Layout from '../layouts/Layout.astro'
import MobileLayout from '../components/MobileLayout.tsx'
---

<Layout title="Chat with Spirit - 3in1 Catholic Spiritual App - v2">
  <div id="app" class="loading">
    Checking authentication...
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-container" class="chat-container hidden flex flex-col h-screen">
    <!-- Header with vibrant design -->
    <header class="border-b border-gray-100 backdrop-blur-md bg-white/95 shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg ring-2 ring-amber-100">
            <span class="text-white font-bold font-geist text-lg">S</span>
          </div>
          <div>
            <h1 class="font-semibold text-gray-800 tracking-tight font-geist">Spirit</h1>
            <p class="text-xs text-amber-600 font-geist" id="welcome-message">Your faith companion ‚ú®</p>
          </div>
        </div>

        <!-- Dev Mode User Switcher (only shows in local development) -->
        <div id="dev-user-switcher" class="hidden flex items-center gap-2">
          <span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700 font-geist">DEV MODE</span>
          <select id="dev-user-select" class="px-3 py-1.5 rounded-[var(--radius-md)] text-sm border border-[var(--color-stone-300)] bg-white font-geist tracking-tight cursor-pointer">
            <option value="">Switch User...</option>
            <option value="dev-user-1">üë§ Alex (Teen)</option>
            <option value="dev-user-2">üë§ Maria (Adult)</option>
            <option value="dev-user-3">üë§ Jake (Child)</option>
            <option value="dev-user-4">üë§ Eleanor (Senior)</option>
          </select>
        </div>

        <button id="logout-btn" class="bg-gradient-to-r from-amber-50 to-orange-50 text-amber-700 px-4 py-2 rounded-xl text-sm hover:from-amber-100 hover:to-orange-100 transition-all duration-200 border border-amber-200 font-geist tracking-tight font-medium hover:shadow-md">Logout</button>
      </div>
    </header>

    <!-- Age Banner -->
    <div id="age-banner" class="hidden">
      <!-- Banner content will be set dynamically -->
    </div>

    <!-- Mobile Layout with Bottom Tabs -->
    <div class="flex-1 w-full min-h-0">
      <MobileLayout client:load />
    </div>

    <!-- Floating Heart Icon for Feeling Check-in -->
    <div id="floating-heart" class="fixed left-4 top-1/2 -translate-y-1/2 w-14 h-14 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full shadow-xl flex items-center justify-center text-2xl cursor-pointer hover:scale-110 active:scale-95 transition-all duration-200 z-50 hover:shadow-2xl select-none touch-none">
      ‚ù§Ô∏è
    </div>

    <!-- Feeling Popup Modal (hidden by default) -->
    <div id="feeling-modal" class="hidden fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-gradient-to-br from-purple-50 via-blue-50 to-amber-50 rounded-3xl shadow-2xl p-0 max-w-sm w-full max-h-[90vh] overflow-y-auto flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-200 to-blue-200 px-6 py-4 text-center rounded-t-3xl">
          <div class="text-4xl mb-1">‚ù§Ô∏è</div>
          <h3 class="text-xl font-semibold text-purple-800">How are you feeling?</h3>
          <p class="text-sm text-purple-700 mt-1">Share your heart, and I'll share a verse and prayer for you.</p>
        </div>

        <!-- Emojis Grid -->
        <div id="feeling-emojis" class="grid grid-cols-4 gap-2 p-4">
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-yellow-50 to-yellow-100 hover:from-yellow-100 hover:to-yellow-200 border border-yellow-200" data-feeling="joyful" data-emoji="üòä">
            <span class="text-2xl">üòä</span>
            <span class="text-xs text-yellow-700 mt-1">Joyful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 border border-green-200" data-feeling="grateful" data-emoji="üôè">
            <span class="text-2xl">üôè</span>
            <span class="text-xs text-green-700 mt-1">Grateful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 border border-blue-200" data-feeling="peaceful" data-emoji="üòå">
            <span class="text-2xl">üòå</span>
            <span class="text-xs text-blue-700 mt-1">Peaceful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 border border-orange-200" data-feeling="anxious" data-emoji="üò∞">
            <span class="text-2xl">üò∞</span>
            <span class="text-xs text-orange-700 mt-1">Anxious</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 border border-purple-200" data-feeling="sad" data-emoji="üò¢">
            <span class="text-2xl">üò¢</span>
            <span class="text-xs text-purple-700 mt-1">Sad</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 border border-red-200" data-feeling="struggling" data-emoji="üò£">
            <span class="text-2xl">üò£</span>
            <span class="text-xs text-red-700 mt-1">Struggling</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 border border-gray-200" data-feeling="tired" data-emoji="üò¥">
            <span class="text-2xl">üò¥</span>
            <span class="text-xs text-gray-600 mt-1">Tired</span>
          </button>
          <button id="close-modal-btn" class="flex flex-col items-center p-3 rounded-xl hover:scale-105 transition-all bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 border border-gray-300">
            <span class="text-2xl">‚úï</span>
            <span class="text-xs text-gray-600 mt-1">Close</span>
          </button>
        </div>

        <!-- Response Section (hidden by default) -->
        <div id="feeling-response" class="hidden">
          <div class="p-4 pb-6">
            <!-- Verse Section - Pastel Purple -->
            <div class="mb-3 p-4 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-xl border-l-4 border-purple-300 shadow-sm">
              <p class="text-xs text-purple-700 font-medium mb-2">üìñ BIBLE VERSE</p>
              <p id="verse-text" class="text-sm text-gray-700 italic"></p>
            </div>

            <!-- Prayer Section - Pastel Blue -->
            <div class="p-4 bg-gradient-to-br from-blue-100 to-cyan-100 rounded-xl border-l-4 border-blue-300 shadow-sm">
              <p class="text-xs text-blue-700 font-medium mb-2">üôè PRAYER</p>
              <p id="prayer-text" class="text-sm text-gray-700"></p>
            </div>

            <div class="flex gap-2 mt-4">
              <button id="back-to-emojis" class="flex-1 py-3 px-4 bg-gradient-to-r from-purple-200 to-blue-200 hover:from-purple-300 hover:to-blue-300 text-purple-800 rounded-xl text-sm font-medium transition-all shadow-md hover:shadow-lg">
                ‚Üê Choose another feeling
              </button>
              <button id="done-feeling" class="flex-1 py-3 px-4 bg-gradient-to-r from-green-200 to-emerald-200 hover:from-green-300 hover:to-emerald-300 text-green-800 rounded-xl text-sm font-medium transition-all shadow-md hover:shadow-lg">
                Done ‚úì
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    // Set API URL based on environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    window.PUBLIC_BASE_API_URL = isLocalhost
      ? 'http://localhost:8787'
      : 'https://3in1-worker.ailabs-hq.workers.dev';

    // DOM elements
    const app = document.getElementById('app');
    const chatContainer = document.getElementById('chat-container');
    const logoutBtn = document.getElementById('logout-btn');
    const devUserSwitcher = document.getElementById('dev-user-switcher');
    const devUserSelect = document.getElementById('dev-user-select');

    let currentUser = null;

    // Dev mode test users
    const devTestUsers = {
      'dev-user-1': {
        id: 'dev-user-1',
        name: 'Alex Thompson',
        email: 'alex teen@example.com',
        ageGroup: 'teen',
        avatar_url: undefined
      },
      'dev-user-2': {
        id: 'dev-user-2',
        name: 'Maria Garcia',
        email: 'maria adult@example.com',
        ageGroup: 'adult',
        avatar_url: undefined
      },
      'dev-user-3': {
        id: 'dev-user-3',
        name: 'Jake Smith',
        email: 'jake child@example.com',
        ageGroup: 'child',
        avatar_url: undefined
      },
      'dev-user-4': {
        id: 'dev-user-4',
        name: 'Eleanor Davis',
        email: 'eleanor senior@example.com',
        ageGroup: 'senior',
        avatar_url: undefined
      }
    };

    // Initialize app
    async function init() {
      try {
        const token = localStorage.getItem('session_token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

          const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/validate', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          const { user } = await response.json();
          currentUser = user;

          // Set welcome message with user's first name
          const welcomeMessage = document.getElementById('welcome-message');
          if (user && user.name && welcomeMessage) {
            const firstName = user.name.split(' ')[0];
            welcomeMessage.textContent = `Hi, ${firstName}! üôè`;
          }

          // Hide loading, show chat
          app.classList.add('hidden');
          chatContainer.classList.remove('hidden');

          // Show dev user switcher in localhost
          if (isLocalhost) {
            console.log('Localhost detected, showing dev user switcher');
            devUserSwitcher.classList.remove('hidden');
          } else {
            console.log('Not localhost, hiding dev user switcher');
          }

          // Show age banner
          showAgeBanner();
        } else {
          localStorage.removeItem('session_token');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        window.location.href = '/login';
      }
    }

    // Show age banner
    function showAgeBanner() {
      const ageGroup = localStorage.getItem('user_age_group');
      const ageBanner = document.getElementById('age-banner');

      console.log('üé® showAgeBanner called - ageGroup:', ageGroup, 'ageBanner element:', !!ageBanner);

      if (!ageGroup || !ageBanner) {
        console.log('‚ö†Ô∏è Age banner not showing - ageGroup:', ageGroup, 'has ageBanner:', !!ageBanner);
        return;
      }

      const ageMessages = {
        'child': {
          emoji: 'üë∂',
          title: 'Young Explorer of Faith',
          message: 'Discovering the wonders of Scripture together',
          gradient: 'from-yellow-100 to-orange-100',
          icon: '‚≠ê'
        },
        'teen': {
          emoji: 'üåü',
          title: 'Growing in Faith',
          message: 'Exploring what it means to follow Jesus',
          gradient: 'from-blue-100 to-indigo-100',
          icon: 'üôè'
        },
        'young-adult': {
          emoji: 'üéì',
          title: 'Journeying Through Scripture',
          message: 'Finding wisdom and purpose in God\'s Word',
          gradient: 'from-purple-100 to-pink-100',
          icon: '‚ú®'
        },
        'adult': {
          emoji: 'üåø',
          title: 'Walking in Faith',
          message: 'Applying Scripture to everyday life',
          gradient: 'from-green-100 to-emerald-100',
          icon: 'üìñ'
        },
        'midlife': {
          emoji: 'üåÖ',
          title: 'Deepening Spiritual Roots',
          message: 'Finding peace and meaning in Scripture',
          gradient: 'from-amber-100 to-yellow-100',
          icon: 'üïäÔ∏è'
        },
        'senior': {
          emoji: 'üå∫',
          title: 'Wisdom in Faith',
          message: 'Sharing the richness of a life in Scripture',
          gradient: 'from-rose-100 to-pink-100',
          icon: 'üíí'
        }
      };

      const ageInfo = ageMessages[ageGroup];
      if (!ageInfo) {
        console.log('‚ö†Ô∏è No ageInfo found for ageGroup:', ageGroup);
        return;
      }

      console.log('üé® Setting age banner:', ageInfo.title, '-', ageInfo.message);

      ageBanner.className = `bg-gradient-to-r ${ageInfo.gradient} border-b border-[var(--color-border)] px-4 py-2`;
      ageBanner.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-2xl">${ageInfo.emoji}</span>
            <div>
              <p class="text-sm font-semibold text-[var(--color-stone-800)] font-geist tracking-tight">
                ${ageInfo.icon} ${ageInfo.title}
              </p>
              <p class="text-xs text-[var(--color-stone-600)] font-geist font-light">${ageInfo.message}</p>
            </div>
          </div>
        </div>
      `;
      ageBanner.classList.remove('hidden');
      console.log('‚úÖ Age banner displayed successfully!');
    }

    // Make showAgeBanner available globally for ChatInterface to call
    window.updateAgeBanner = showAgeBanner;

    // Handle logout
    async function handleLogout() {
      try {
        const token = localStorage.getItem('session_token');
        if (token) {
          await fetch(window.PUBLIC_BASE_API_URL + '/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
        }

        localStorage.removeItem('session_token');
        window.location.href = '/';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }

    // Handle dev user switching
    async function switchToDevUser(userId) {
      const devUser = devTestUsers[userId];
      if (!devUser) return;

      console.log('üîÑ Switching to dev user:', userId, 'with ageGroup:', devUser.ageGroup);

      try {
        // Get a dev session token from the backend
        const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/dev-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ user: devUser })
        });

        if (response.ok) {
          const { session_token } = await response.json();

          // Store the new session token
          localStorage.setItem('session_token', session_token);

          // Update age group in localStorage
          localStorage.setItem('user_age_group', devUser.ageGroup);
          console.log('‚úÖ Set user_age_group in localStorage:', devUser.ageGroup);

          // Save age group to profile (which also saves to notes for Spirit to read)
          await fetch(window.PUBLIC_BASE_API_URL + '/api/user/profile', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + session_token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ageGroup: devUser.ageGroup })
          });

          console.log('‚úÖ Profile saved, reloading page...');
          // Reload the page to reinitialize with new user
          window.location.reload();
        } else {
          console.error('Failed to switch to dev user');
        }
      } catch (error) {
        console.error('Error switching dev user:', error);
      }
    }

    // Logout button event listener
    logoutBtn.addEventListener('click', handleLogout);

    // Dev user switcher event listener
    devUserSelect.addEventListener('change', (e) => {
      const selectedUserId = e.target.value;
      if (selectedUserId) {
        switchToDevUser(selectedUserId);
        // Reset dropdown
        e.target.value = '';
      }
    });

    // Floating Heart Icon - Draggable and Modal
    const floatingHeart = document.getElementById('floating-heart');
    const feelingModal = document.getElementById('feeling-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const feelingEmojis = document.getElementById('feeling-emojis');
    const feelingResponse = document.getElementById('feeling-response');
    const feelingResponseContent = document.getElementById('feeling-response-content');
    const backToEmojisBtn = document.getElementById('back-to-emojis');
    const verseTextEl = document.getElementById('verse-text');
    const prayerTextEl = document.getElementById('prayer-text');
    let isDragging = false;
    let startX, startY, initialX, initialY;

    // Make heart draggable
    if (floatingHeart) {
      // Mouse events
      floatingHeart.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      // Touch events
      floatingHeart.addEventListener('touchstart', dragStart, { passive: false });
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('touchend', dragEnd);

      // Click to open modal (only if not dragging)
      floatingHeart.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Floating heart clicked!', isDragging);
        if (!isDragging) {
          openModal();
        } else {
          console.log('Was dragging, not opening modal');
        }
      });
    }

    function dragStart(e) {
      const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

      startX = clientX;
      startY = clientY;
      initialX = floatingHeart.offsetLeft;
      initialY = floatingHeart.offsetTop;
      isDragging = false;
    }

    function drag(e) {
      if (!startX || !startY) return;

      const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

      const dx = clientX - startX;
      const dy = clientY - startY;

      // Only consider it dragging if moved more than 5px
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        isDragging = true;
        if (e.type === 'touchmove') e.preventDefault();

        let newX = initialX + dx;
        let newY = initialY + dy;

        // Keep within viewport bounds
        const maxX = window.innerWidth - floatingHeart.offsetWidth;
        const maxY = window.innerHeight - floatingHeart.offsetHeight;

        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));

        floatingHeart.style.left = newX + 'px';
        floatingHeart.style.top = newY + 'px';
        floatingHeart.style.right = 'auto';
        floatingHeart.style.bottom = 'auto';
      }
    }

    function dragEnd() {
      startX = null;
      startY = null;
      setTimeout(() => { isDragging = false; }, 100);
    }

    function openModal() {
      // Re-fetch elements in case they're not available
      const modal = document.getElementById('feeling-modal');
      const emojis = document.getElementById('feeling-emojis');
      const response = document.getElementById('feeling-response');
      const contentDiv = document.getElementById('feeling-response-content');

      if (!modal) {
        console.error('Feeling modal not found');
        return;
      }

      console.log('Opening modal - elements:', { modal: !!modal, emojis: !!emojis, response: !!response, contentDiv: !!contentDiv });

      // Reset modal state
      if (emojis) emojis.classList.remove('hidden');
      if (response) response.classList.add('hidden');
      if (contentDiv) contentDiv.innerHTML = '';
      modal.classList.remove('hidden');
    }

    function closeModal() {
      const modal = document.getElementById('feeling-modal');
      if (modal) modal.classList.add('hidden');
    }

    function showEmojis() {
      const emojis = document.getElementById('feeling-emojis');
      const response = document.getElementById('feeling-response');
      if (emojis) emojis.classList.remove('hidden');
      if (response) response.classList.add('hidden');
      console.log('Showing emoji selection');
    }

    function showResponse(content) {
      const emojis = document.getElementById('feeling-emojis');
      const response = document.getElementById('feeling-response');
      const vText = document.getElementById('verse-text');
      const pText = document.getElementById('prayer-text');

      // Show response section, hide emojis
      if (emojis) emojis.classList.add('hidden');
      if (response) response.classList.remove('hidden');

      // Handle loading spinner
      if (content.includes('animate-spin')) {
        if (vText) vText.textContent = 'Loading...';
        if (pText) pText.textContent = 'Loading...';
        return;
      }

      // Parse content and extract verse and prayer
      let verseText = '';
      let prayerText = '';

      // Check if content has BIBLE VERSE and PRAYER markers (fallback format)
      if (content.includes('BIBLE VERSE') && content.includes('PRAYER')) {
        const parts = content.split('PRAYER');

        // Extract verse from first part
        const verseMatch = parts[0].match(/text-gray-700[^>]*>(.*?)</s) || parts[0].match(/italic[^>]*>(.*?)</s) || parts[0].match(/<p[^>]*>(.*?)<\/p>/s);
        if (verseMatch) {
          verseText = verseMatch[1].replace(/<[^>]+>/g, '').trim();
        }

        // Extract prayer from second part
        const prayerMatch = parts[1]?.match(/text-gray-700[^>]*>(.*?)</s) || parts[1]?.match(/<p[^>]*>(.*?)<\/p>/s);
        if (prayerMatch) {
          prayerText = prayerMatch[1].replace(/<[^>]+>/g, '').trim();
        }
      } else {
        // Plain text or API response - try to parse
        const textContent = content.replace(/<[^>]+>/g, '\n').replace(/\n+/g, '\n').trim();
        const lines = textContent.split('\n').filter(l => l.trim());
        let foundPrayer = false;

        for (const line of lines) {
          const lower = line.toLowerCase().trim();

          // Skip headers
          if (lower.includes('bible verse') || lower.includes('verse') || lower.includes('üìñ')) {
            continue;
          }
          if (lower.includes('prayer') || lower.includes('let us pray') || lower.includes('üôè')) {
            foundPrayer = true;
            continue;
          }

          // Add to appropriate section
          if (foundPrayer) {
            prayerText += line + ' ';
          } else {
            verseText += line + ' ';
          }
        }

        // If no prayer found, put everything in verse
        if (!prayerText && verseText) {
          verseText = textContent;
        }
      }

      // Helper function to format text with each sentence on a new line
      function formatTextWithSentenceBreaks(text) {
        return text
          .replace(/\*\*/g, '') // Remove bold markdown
          .replace(/([.!?])\s+/g, '$1\n') // Put sentence-ending punctuation on new line
          .replace(/\n+/g, '\n') // Remove extra newlines
          .trim();
      }

      // Populate the elements with formatted text
      if (vText) vText.textContent = formatTextWithSentenceBreaks(verseText.trim()) || 'Loading your verse...';
      if (pText) pText.textContent = formatTextWithSentenceBreaks(prayerText.trim()) || 'Loading your prayer...';

      // Ensure sections are visible
      const verseSection = vText?.closest('.mb-3, p-4');
      const prayerSection = pText?.closest('.p-4');
      if (verseSection) verseSection.style.display = 'block';
      if (prayerSection) prayerSection.style.display = 'block';
    }

    // Close modal button
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeModal);
    }

    // Back to emojis button
    if (backToEmojisBtn) {
      backToEmojisBtn.addEventListener('click', showEmojis);
    }

    // Done feeling button
    const doneFeelingBtn = document.getElementById('done-feeling');
    if (doneFeelingBtn) {
      doneFeelingBtn.addEventListener('click', closeModal);
    }

    // Close modal when clicking outside
    if (feelingModal) {
      feelingModal.addEventListener('click', (e) => {
        if (e.target === feelingModal) {
          closeModal();
        }
      });
    }

    // Handle feeling button clicks - fetch verse and prayer
    document.querySelectorAll('.feeling-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const feeling = btn.getAttribute('data-feeling');
        const emoji = btn.getAttribute('data-emoji');
        if (feeling && emoji) {
          // Show loading state
          showResponse('<div class="flex items-center justify-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div></div>');

          try {
            const token = localStorage.getItem('session_token');

            // Create message for Spirit
            const feelingMessage = `I'm feeling ${feeling} ${emoji}. Please share a relevant bible verse and write a personal prayer for ME to say - in first person as if I'm praying directly to God (using "I", "me", "my" not "we"). Make the prayer sound like I'm speaking, not you.`;

            if (!token) {
              // No token - show fallback response
              const fallbackResponses = {
                joyful: { verse: '"This is the day that the Lord has made; let us rejoice and be glad in it." - Psalm 118:24', prayer: 'Thank You, Lord, for the joy I feel today. Help me share this joy with others and let it shine through me.' },
                grateful: { verse: '"Give thanks to the Lord, for he is good; his love endures forever." - Psalm 107:1', prayer: 'Thank You, God, for all Your blessings. Open my eyes to see Your goodness in every moment today.' },
                peaceful: { verse: '"Peace I leave with you; my peace I give you. I do not give to you as the world gives. Do not let your hearts be troubled and do not be afraid." - John 14:27', prayer: 'Thank You, Jesus, for Your peace. Calm my heart and mind as I rest in Your presence today.' },
                anxious: { verse: '"Do not be anxious about anything, but in every situation, by prayer and petition, with thanksgiving, present your requests to God." - Philippians 4:6', prayer: 'Lord, I bring You my worries and anxieties. Please give me Your peace and guide me through this moment.' },
                sad: { verse: '"The Lord is close to the brokenhearted and saves those who are crushed in spirit." - Psalm 34:18', prayer: 'God, I feel sad today. Thank You for being close to me. Comfort my heart and help me feel Your presence.' },
                struggling: { verse: '"My grace is sufficient for you, for my power is made perfect in weakness." - 2 Corinthians 12:9', prayer: 'Lord, I\'m struggling right now. Help me trust that Your grace is enough for me today and give me Your strength.' },
                tired: { verse: '"Come to me, all you who are weary and burdened, and I will give you rest." - Matthew 11:28', prayer: 'Jesus, I\'m tired and need Your rest. Please refresh my spirit and give me the strength I need.' },
              };

              const response = fallbackResponses[feeling] || fallbackResponses.joyful;
              showResponse(`
                <div class="mb-3">
                  <p class="text-xs text-pink-600 font-medium mb-1">üìñ BIBLE VERSE</p>
                  <p class="italic text-gray-700">${response.verse}</p>
                </div>
                <div>
                  <p class="text-xs text-pink-600 font-medium mb-1">üôè PRAYER</p>
                  <p class="text-gray-700">${response.prayer}</p>
                </div>
              `);
              return;
            }

            // Send to backend API for personalized response
            const apiResponse = await fetch(window.PUBLIC_BASE_API_URL + '/api/chat', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                messages: [{ role: 'user', content: feelingMessage }],
              }),
            });

            if (!apiResponse.ok) {
              throw new Error('Failed to get response');
            }

            // Read the stream
            const reader = apiResponse.body?.getReader();
            if (!reader) {
              throw new Error('No response body');
            }

            const decoder = new TextDecoder();
            let fullResponse = '';
            let buffer = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });

              // Parse AI SDK data stream format
              const lines = buffer.split(/(?=0:|1:|2:)/);
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (!line) continue;

                const match = line.match(/^[012]:"(.*)"(?:,"[0-9]+:")?$/s);
                if (match) {
                  const content = match[1]
                    .replace(/\\"/g, '"')
                    .replace(/\\\\/g, '\\')
                    .replace(/\\n/g, '\n');
                  fullResponse += content;
                }
              }
            }

            // Display the response
            showResponse(`
              <div class="prose prose-sm">
                <p class="text-gray-700 whitespace-pre-line">${fullResponse}</p>
              </div>
            `);

          } catch (error) {
            console.error('Error getting verse and prayer:', error);
            // Show fallback on error
            showResponse(`
              <div class="text-center text-gray-500">
                <p>Unable to load response. Please try again.</p>
              </div>
            `);
          }
        }
      });
    });

    // Initialize on load
    init();
  </script>

  <style>
    #app.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100dvh;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Inter', sans-serif;
    }

    /* Safe area support for mobile devices with notches/home indicators */
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Modal animation */
    @keyframes scale-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-scale-in {
      animation: scale-in 0.2s ease-out;
    }

    /* Background pattern with spiritual theme */
    #chat-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23C84B9F' stroke-width='0.5' opacity='0.08'%3E%3Cpath d='M30 5c-13.8 0-25 11.2-25 25s11.2 25 25 25 25-11.2 25-25-11.2-25-25zm0 45c-11 0-20-9-20-20s9-20 20-20 20 9 20 20-9 20-20z'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%238B5FCF' stroke-width='0.5' opacity='0.06'%3E%3Cpath d='M20 35c-8.3 0-15-6.7-15-15V10h30v10c0 8.3-6.7 15-15 15z'/%3E%3Cpath d='M30 20h10v15c0 2.8-2.2 5-5 5H30'/%3E%3C/g%3E%3C/svg%3E");
      background-repeat: repeat;
      pointer-events: none;
      opacity: 0.5;
    }

    /* Floating decorative elements */
    .floating-cross::before,
    .floating-cross::after {
      content: '‚úù';
      position: absolute;
      font-size: 1.5rem;
      opacity: 0.05;
      animation: floatUp 20s infinite linear;
    }

    .floating-cross::before {
      left: 10%;
      animation-delay: 0s;
    }

    .floating-cross::after {
      right: 15%;
      animation-delay: 10s;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.05;
      }
      90% {
        opacity: 0.05;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }
  </style>

  <!-- Google Translate Script -->
  <script>
    // Pre-load Google Translate - v3
    (function initGoogleTranslate() {
      if (document.getElementById('google_translate_element_chat')) {
        return;
      }

      const gtElement = document.createElement('div');
      gtElement.id = 'google_translate_element_chat';
      gtElement.style.display = 'none';
      document.body.appendChild(gtElement);

      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.charset = 'UTF-8';
      script.async = true;
      script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInitChat';

      window.googleTranslateElementInitChat = function() {
        new google.translate.TranslateElement({
          pageLanguage: 'en',
          includedLanguages: 'es,pt,fr,de,it,pl,tl,vi,zh-CN,ja,ar,hi,ta,te,kn,ur,la',
          layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
          autoDisplay: false
        }, 'google_translate_element_chat');
      };

      document.head.appendChild(script);
    })();

    // Handle language change events from LanguageSelector
    window.addEventListener('languageChange', function(e) {
      const langCode = e.detail.language;
      if (langCode === 'en') return;

      // Wait for Google Translate to be ready
      const checkTranslate = setInterval(function() {
        const selectElement = document.querySelector('.goog-te-combo');
        if (selectElement) {
          clearInterval(checkTranslate);
          selectElement.value = langCode;
          selectElement.dispatchEvent(new Event('change'));
        }
      }, 100);

      // Stop checking after 5 seconds
      setTimeout(() => clearInterval(checkTranslate), 5000);
    });
  </script>

  <style is:global>
    /* Hide Google Translate widget */
    .goog-te-banner-frame, .goog-te-gadget, .skiptranslate, .goog-te-spinner, .goog-te-spinner-pos {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      width: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
    }

    .goog-te-combo {
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    #google_translate_element_chat {
      display: none !important;
    }

    iframe[src*="translate.google.com"],
    iframe[src*="google.com/translate"] {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      left: -9999px !important;
    }

    .skiptranslate, .skiptranslate *, .goog-te-gadget, .goog-te-gadget * {
      display: none !important;
      visibility: hidden !important;
    }
  </style>
</Layout>
