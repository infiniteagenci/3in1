---
// src/pages/chat.astro
import Layout from '../layouts/Layout.astro'
import ChatInterface from '../components/ChatInterface.tsx'
---

<Layout title="Chat with Spirit - 3in1 Catholic Spiritual App">
  <div id="app" class="loading">
    Checking authentication...
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-container" class="chat-container hidden flex flex-col h-screen">
    <!-- Header with theme design styles -->
    <header class="border-[var(--color-border)] border-b backdrop-blur shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between rounded-[var(--radius-2xl)]">
        <div class="flex items-center  ">
          <div class="w-10 h-10 rounded-[var(--radius-md)] bg-gradient-to-br from-[var(--color-accent-purple)] to-[var(--color-accent-blue)] flex items-center justify-center mr-3 shadow-sm">
            <span class="text-white font-bold font-geist">S</span>
          </div>
          <div>
            <h1 class="font-semibold text-[var(--color-stone-700)] tracking-tight font-geist">Spirit</h1>
            <p class="text-xs text-[var(--color-stone-500)] font-geist">Your friendly faith companion</p>
          </div>
        </div>

        <!-- Dev Mode User Switcher (only shows in local development) -->
        <div id="dev-user-switcher" class="hidden flex items-center gap-2">
          <span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700 font-geist">DEV MODE</span>
          <select id="dev-user-select" class="px-3 py-1.5 rounded-[var(--radius-md)] text-sm border border-[var(--color-stone-300)] bg-white font-geist tracking-tight cursor-pointer">
            <option value="">Switch User...</option>
            <option value="dev-user-1">üë§ Alex (Teen)</option>
            <option value="dev-user-2">üë§ Maria (Adult)</option>
            <option value="dev-user-3">üë§ Jake (Child)</option>
            <option value="dev-user-4">üë§ Eleanor (Senior)</option>
          </select>
        </div>

        <button id="logout-btn" class="bg-[var(--color-stone-50)] text-[var(--color-stone-600)] px-4 py-1.5 rounded-[var(--radius-md)] text-sm hover:bg-[var(--color-stone-100)] transition-colors border border-[var(--color-white)] font-geist tracking-tight">Logout</button>
      </div>
    </header>

    <!-- Age Banner -->
    <div id="age-banner" class="hidden">
      <!-- Banner content will be set dynamically -->
    </div>

    <!-- AI Chat Interface -->
    <div class="flex-1 w-full min-h-0 pb-2">
      <ChatInterface client:load />
    </div>
  </div>

  <script>
    // Set API URL based on environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    window.PUBLIC_BASE_API_URL = isLocalhost
      ? 'http://localhost:8788'
      : 'https://3in1-worker.ailabs-hq.workers.dev';

    // DOM elements
    const app = document.getElementById('app');
    const chatContainer = document.getElementById('chat-container');
    const logoutBtn = document.getElementById('logout-btn');
    const devUserSwitcher = document.getElementById('dev-user-switcher');
    const devUserSelect = document.getElementById('dev-user-select');

    let currentUser = null;

    // Dev mode test users
    const devTestUsers = {
      'dev-user-1': {
        id: 'dev-user-1',
        name: 'Alex Thompson',
        email: 'alex teen@example.com',
        ageGroup: 'teen',
        avatar_url: undefined
      },
      'dev-user-2': {
        id: 'dev-user-2',
        name: 'Maria Garcia',
        email: 'maria adult@example.com',
        ageGroup: 'adult',
        avatar_url: undefined
      },
      'dev-user-3': {
        id: 'dev-user-3',
        name: 'Jake Smith',
        email: 'jake child@example.com',
        ageGroup: 'child',
        avatar_url: undefined
      },
      'dev-user-4': {
        id: 'dev-user-4',
        name: 'Eleanor Davis',
        email: 'eleanor senior@example.com',
        ageGroup: 'senior',
        avatar_url: undefined
      }
    };

    // Initialize app
    async function init() {
      try {
        const token = localStorage.getItem('session_token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

          const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/validate', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          const { user } = await response.json();
          currentUser = user;

          // Hide loading, show chat
          app.classList.add('hidden');
          chatContainer.classList.remove('hidden');

          // Show dev user switcher in localhost
          if (isLocalhost) {
            console.log('Localhost detected, showing dev user switcher');
            devUserSwitcher.classList.remove('hidden');
          } else {
            console.log('Not localhost, hiding dev user switcher');
          }

          // Show age banner
          showAgeBanner();
        } else {
          localStorage.removeItem('session_token');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        window.location.href = '/login';
      }
    }

    // Show age banner
    function showAgeBanner() {
      const ageGroup = localStorage.getItem('user_age_group');
      const ageBanner = document.getElementById('age-banner');

      console.log('üé® showAgeBanner called - ageGroup:', ageGroup, 'ageBanner element:', !!ageBanner);

      if (!ageGroup || !ageBanner) {
        console.log('‚ö†Ô∏è Age banner not showing - ageGroup:', ageGroup, 'has ageBanner:', !!ageBanner);
        return;
      }

      const ageMessages = {
        'child': {
          emoji: 'üë∂',
          title: 'Young Explorer of Faith',
          message: 'Discovering the wonders of Scripture together',
          gradient: 'from-yellow-100 to-orange-100',
          icon: '‚≠ê'
        },
        'teen': {
          emoji: 'üåü',
          title: 'Growing in Faith',
          message: 'Exploring what it means to follow Jesus',
          gradient: 'from-blue-100 to-indigo-100',
          icon: 'üôè'
        },
        'young-adult': {
          emoji: 'üéì',
          title: 'Journeying Through Scripture',
          message: 'Finding wisdom and purpose in God\'s Word',
          gradient: 'from-purple-100 to-pink-100',
          icon: '‚ú®'
        },
        'adult': {
          emoji: 'üåø',
          title: 'Walking in Faith',
          message: 'Applying Scripture to everyday life',
          gradient: 'from-green-100 to-emerald-100',
          icon: 'üìñ'
        },
        'midlife': {
          emoji: 'üåÖ',
          title: 'Deepening Spiritual Roots',
          message: 'Finding peace and meaning in Scripture',
          gradient: 'from-amber-100 to-yellow-100',
          icon: 'üïäÔ∏è'
        },
        'senior': {
          emoji: 'üå∫',
          title: 'Wisdom in Faith',
          message: 'Sharing the richness of a life in Scripture',
          gradient: 'from-rose-100 to-pink-100',
          icon: 'üíí'
        }
      };

      const ageInfo = ageMessages[ageGroup];
      if (!ageInfo) {
        console.log('‚ö†Ô∏è No ageInfo found for ageGroup:', ageGroup);
        return;
      }

      console.log('üé® Setting age banner:', ageInfo.title, '-', ageInfo.message);

      ageBanner.className = `bg-gradient-to-r ${ageInfo.gradient} border-b border-[var(--color-border)] px-4 py-2`;
      ageBanner.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-2xl">${ageInfo.emoji}</span>
            <div>
              <p class="text-sm font-semibold text-[var(--color-stone-800)] font-geist tracking-tight">
                ${ageInfo.icon} ${ageInfo.title}
              </p>
              <p class="text-xs text-[var(--color-stone-600)] font-geist font-light">${ageInfo.message}</p>
            </div>
          </div>
        </div>
      `;
      ageBanner.classList.remove('hidden');
      console.log('‚úÖ Age banner displayed successfully!');
    }

    // Make showAgeBanner available globally for ChatInterface to call
    window.updateAgeBanner = showAgeBanner;

    // Handle logout
    async function handleLogout() {
      try {
        const token = localStorage.getItem('session_token');
        if (token) {
          await fetch(window.PUBLIC_BASE_API_URL + '/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
        }

        localStorage.removeItem('session_token');
        window.location.href = '/';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }

    // Handle dev user switching
    async function switchToDevUser(userId) {
      const devUser = devTestUsers[userId];
      if (!devUser) return;

      console.log('üîÑ Switching to dev user:', userId, 'with ageGroup:', devUser.ageGroup);

      try {
        // Get a dev session token from the backend
        const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/dev-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ user: devUser })
        });

        if (response.ok) {
          const { session_token } = await response.json();

          // Store the new session token
          localStorage.setItem('session_token', session_token);

          // Update age group in localStorage
          localStorage.setItem('user_age_group', devUser.ageGroup);
          console.log('‚úÖ Set user_age_group in localStorage:', devUser.ageGroup);

          // Save age group to profile (which also saves to notes for Spirit to read)
          await fetch(window.PUBLIC_BASE_API_URL + '/api/user/profile', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + session_token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ageGroup: devUser.ageGroup })
          });

          console.log('‚úÖ Profile saved, reloading page...');
          // Reload the page to reinitialize with new user
          window.location.reload();
        } else {
          console.error('Failed to switch to dev user');
        }
      } catch (error) {
        console.error('Error switching dev user:', error);
      }
    }

    // Logout button event listener
    logoutBtn.addEventListener('click', handleLogout);

    // Dev user switcher event listener
    devUserSelect.addEventListener('change', (e) => {
      const selectedUserId = e.target.value;
      if (selectedUserId) {
        switchToDevUser(selectedUserId);
        // Reset dropdown
        e.target.value = '';
      }
    });

    // Initialize on load
    init();
  </script>

  <style>
    #app.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Inter', sans-serif;
    }
  </style>
</Layout>
