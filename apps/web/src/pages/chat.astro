---
// src/pages/chat.astro
import Layout from '../layouts/Layout.astro'
import ChatInterface from '../components/ChatInterface.jsx'
---

<Layout title="Chat with Spirit - 3in1 Spiritual App">
  <div id="app" class="loading">
    Checking authentication...
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-container" class="chat-container hidden flex flex-col h-screen">
    <!-- Header -->
    <header class="w-full bg-gradient-to-r from-purple-400 via-purple-500 to-blue-400 shadow-md">
      <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center">
          <div class="avatar w-10 h-10 rounded-full bg-white text-purple-600 flex items-center justify-center font-bold mr-3 shadow-sm">S</div>
          <div>
            <h1 class="font-semibold text-white">Spirit</h1>
            <p class="text-xs text-purple-100">Your spiritual guide</p>
          </div>
        </div>
        <button id="logout-btn" class="logout-btn bg-white/20 text-white px-4 py-1.5 rounded-full text-sm hover:bg-white/30 transition-colors backdrop-blur-sm border border-white/30">Logout</button>
      </div>
    </header>

    <!-- AI Chat Interface -->
    <div class="flex-1 w-full">
      <ChatInterface client:load />
    </div>
  </div>

  <script>
    // Set API URL based on current environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    window.PUBLIC_WORKER_API_URL = isLocalhost
      ? 'http://localhost:8787'
      : 'https://3in1-worker.ailabs-hq.workers.dev';

    // DOM elements
    const app = document.getElementById('app');
    const chatContainer = document.getElementById('chat-container');
    const logoutBtn = document.getElementById('logout-btn');

    let currentUser = null;

    // Initialize app
    async function init() {
      try {
        const token = localStorage.getItem('session_token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        const response = await fetch(PUBLIC_WORKER_API_URL + '/auth/validate', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          const { user } = await response.json();
          currentUser = user;

          // Hide loading, show chat
          app.classList.add('hidden');
          chatContainer.classList.remove('hidden');
        } else {
          localStorage.removeItem('session_token');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        window.location.href = '/login';
      }
    }

    // Handle logout
    async function handleLogout() {
      try {
        const token = localStorage.getItem('session_token');
        if (token) {
          await fetch(PUBLIC_WORKER_API_URL + '/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
        }

        localStorage.removeItem('session_token');
        window.location.href = '/';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }

    // Logout button event listener
    logoutBtn.addEventListener('click', handleLogout);

    // Initialize on load
    init();
  </script>

  <style>
    #app.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</Layout>
