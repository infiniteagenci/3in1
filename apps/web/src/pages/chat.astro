---
// src/pages/chat.astro
import Layout from '../layouts/Layout.astro'
import MobileLayout from '../components/MobileLayout.tsx'
---

<Layout title="Chat with Spirit - 3in1 Catholic Spiritual App">
  <div id="app" class="loading">
    Checking authentication...
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-container" class="chat-container hidden flex flex-col h-screen">
    <!-- Header with vibrant design -->
    <header class="border-b border-gray-100 backdrop-blur-md bg-white/95 shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg ring-2 ring-amber-100">
            <span class="text-white font-bold font-geist text-lg">S</span>
          </div>
          <div>
            <h1 class="font-semibold text-gray-800 tracking-tight font-geist">Spirit</h1>
            <p class="text-xs text-amber-600 font-geist" id="welcome-message">Your faith companion ‚ú®</p>
          </div>
        </div>

        <!-- Dev Mode User Switcher (only shows in local development) -->
        <div id="dev-user-switcher" class="hidden flex items-center gap-2">
          <span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700 font-geist">DEV MODE</span>
          <select id="dev-user-select" class="px-3 py-1.5 rounded-[var(--radius-md)] text-sm border border-[var(--color-stone-300)] bg-white font-geist tracking-tight cursor-pointer">
            <option value="">Switch User...</option>
            <option value="dev-user-1">üë§ Alex (Teen)</option>
            <option value="dev-user-2">üë§ Maria (Adult)</option>
            <option value="dev-user-3">üë§ Jake (Child)</option>
            <option value="dev-user-4">üë§ Eleanor (Senior)</option>
          </select>
        </div>

        <button id="logout-btn" class="bg-gradient-to-r from-amber-50 to-orange-50 text-amber-700 px-4 py-2 rounded-xl text-sm hover:from-amber-100 hover:to-orange-100 transition-all duration-200 border border-amber-200 font-geist tracking-tight font-medium hover:shadow-md">Logout</button>
      </div>
    </header>

    <!-- Age Banner -->
    <div id="age-banner" class="hidden">
      <!-- Banner content will be set dynamically -->
    </div>

    <!-- Mobile Layout with Bottom Tabs -->
    <div class="flex-1 w-full min-h-0">
      <MobileLayout client:load />
    </div>

    <!-- Floating Heart Icon for Feeling Check-in -->
    <div id="floating-heart" class="fixed bottom-24 right-4 w-14 h-14 bg-gradient-to-br from-pink-400 to-rose-500 rounded-full shadow-xl flex items-center justify-center text-2xl cursor-pointer hover:scale-110 active:scale-95 transition-all duration-200 z-50 hover:shadow-2xl select-none touch-none">
      ‚ù§Ô∏è
    </div>

    <!-- Feeling Popup Modal (hidden by default) -->
    <div id="feeling-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl p-6 max-w-sm w-full animate-scale-in">
        <div class="text-center mb-4">
          <div class="text-4xl mb-2">‚ù§Ô∏è</div>
          <h3 class="text-xl font-semibold text-gray-800">How are you feeling?</h3>
          <p class="text-sm text-gray-500 mt-1">Share your heart, and I'll share a verse and prayer for you.</p>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-4">
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="joyful" data-emoji="üòä">
            <span class="text-2xl">üòä</span>
            <span class="text-xs text-gray-600 mt-1">Joyful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="grateful" data-emoji="üôè">
            <span class="text-2xl">üôè</span>
            <span class="text-xs text-gray-600 mt-1">Grateful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="peaceful" data-emoji="üòå">
            <span class="text-2xl">üòå</span>
            <span class="text-xs text-gray-600 mt-1">Peaceful</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="anxious" data-emoji="üò∞">
            <span class="text-2xl">üò∞</span>
            <span class="text-xs text-gray-600 mt-1">Anxious</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="sad" data-emoji="üò¢">
            <span class="text-2xl">üò¢</span>
            <span class="text-xs text-gray-600 mt-1">Sad</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="struggling" data-emoji="üò£">
            <span class="text-2xl">üò£</span>
            <span class="text-xs text-gray-600 mt-1">Struggling</span>
          </button>
          <button class="feeling-btn flex flex-col items-center p-3 rounded-xl hover:bg-pink-50 transition-colors" data-feeling="tired" data-emoji="üò¥">
            <span class="text-2xl">üò¥</span>
            <span class="text-xs text-gray-600 mt-1">Tired</span>
          </button>
          <button id="close-modal-btn" class="flex flex-col items-center p-3 rounded-xl hover:bg-gray-100 transition-colors">
            <span class="text-2xl">‚úï</span>
            <span class="text-xs text-gray-600 mt-1">Close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Set API URL based on environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    window.PUBLIC_BASE_API_URL = isLocalhost
      ? 'http://localhost:8787'
      : 'https://3in1-worker.ailabs-hq.workers.dev';

    // DOM elements
    const app = document.getElementById('app');
    const chatContainer = document.getElementById('chat-container');
    const logoutBtn = document.getElementById('logout-btn');
    const devUserSwitcher = document.getElementById('dev-user-switcher');
    const devUserSelect = document.getElementById('dev-user-select');

    let currentUser = null;

    // Dev mode test users
    const devTestUsers = {
      'dev-user-1': {
        id: 'dev-user-1',
        name: 'Alex Thompson',
        email: 'alex teen@example.com',
        ageGroup: 'teen',
        avatar_url: undefined
      },
      'dev-user-2': {
        id: 'dev-user-2',
        name: 'Maria Garcia',
        email: 'maria adult@example.com',
        ageGroup: 'adult',
        avatar_url: undefined
      },
      'dev-user-3': {
        id: 'dev-user-3',
        name: 'Jake Smith',
        email: 'jake child@example.com',
        ageGroup: 'child',
        avatar_url: undefined
      },
      'dev-user-4': {
        id: 'dev-user-4',
        name: 'Eleanor Davis',
        email: 'eleanor senior@example.com',
        ageGroup: 'senior',
        avatar_url: undefined
      }
    };

    // Initialize app
    async function init() {
      try {
        const token = localStorage.getItem('session_token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

          const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/validate', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          const { user } = await response.json();
          currentUser = user;

          // Set welcome message with user's first name
          const welcomeMessage = document.getElementById('welcome-message');
          if (user && user.name && welcomeMessage) {
            const firstName = user.name.split(' ')[0];
            welcomeMessage.textContent = `Hi, ${firstName}! üôè`;
          }

          // Hide loading, show chat
          app.classList.add('hidden');
          chatContainer.classList.remove('hidden');

          // Show dev user switcher in localhost
          if (isLocalhost) {
            console.log('Localhost detected, showing dev user switcher');
            devUserSwitcher.classList.remove('hidden');
          } else {
            console.log('Not localhost, hiding dev user switcher');
          }

          // Show age banner
          showAgeBanner();
        } else {
          localStorage.removeItem('session_token');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        window.location.href = '/login';
      }
    }

    // Show age banner
    function showAgeBanner() {
      const ageGroup = localStorage.getItem('user_age_group');
      const ageBanner = document.getElementById('age-banner');

      console.log('üé® showAgeBanner called - ageGroup:', ageGroup, 'ageBanner element:', !!ageBanner);

      if (!ageGroup || !ageBanner) {
        console.log('‚ö†Ô∏è Age banner not showing - ageGroup:', ageGroup, 'has ageBanner:', !!ageBanner);
        return;
      }

      const ageMessages = {
        'child': {
          emoji: 'üë∂',
          title: 'Young Explorer of Faith',
          message: 'Discovering the wonders of Scripture together',
          gradient: 'from-yellow-100 to-orange-100',
          icon: '‚≠ê'
        },
        'teen': {
          emoji: 'üåü',
          title: 'Growing in Faith',
          message: 'Exploring what it means to follow Jesus',
          gradient: 'from-blue-100 to-indigo-100',
          icon: 'üôè'
        },
        'young-adult': {
          emoji: 'üéì',
          title: 'Journeying Through Scripture',
          message: 'Finding wisdom and purpose in God\'s Word',
          gradient: 'from-purple-100 to-pink-100',
          icon: '‚ú®'
        },
        'adult': {
          emoji: 'üåø',
          title: 'Walking in Faith',
          message: 'Applying Scripture to everyday life',
          gradient: 'from-green-100 to-emerald-100',
          icon: 'üìñ'
        },
        'midlife': {
          emoji: 'üåÖ',
          title: 'Deepening Spiritual Roots',
          message: 'Finding peace and meaning in Scripture',
          gradient: 'from-amber-100 to-yellow-100',
          icon: 'üïäÔ∏è'
        },
        'senior': {
          emoji: 'üå∫',
          title: 'Wisdom in Faith',
          message: 'Sharing the richness of a life in Scripture',
          gradient: 'from-rose-100 to-pink-100',
          icon: 'üíí'
        }
      };

      const ageInfo = ageMessages[ageGroup];
      if (!ageInfo) {
        console.log('‚ö†Ô∏è No ageInfo found for ageGroup:', ageGroup);
        return;
      }

      console.log('üé® Setting age banner:', ageInfo.title, '-', ageInfo.message);

      ageBanner.className = `bg-gradient-to-r ${ageInfo.gradient} border-b border-[var(--color-border)] px-4 py-2`;
      ageBanner.innerHTML = `
        <div class="max-w-5xl mx-auto flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-2xl">${ageInfo.emoji}</span>
            <div>
              <p class="text-sm font-semibold text-[var(--color-stone-800)] font-geist tracking-tight">
                ${ageInfo.icon} ${ageInfo.title}
              </p>
              <p class="text-xs text-[var(--color-stone-600)] font-geist font-light">${ageInfo.message}</p>
            </div>
          </div>
        </div>
      `;
      ageBanner.classList.remove('hidden');
      console.log('‚úÖ Age banner displayed successfully!');
    }

    // Make showAgeBanner available globally for ChatInterface to call
    window.updateAgeBanner = showAgeBanner;

    // Handle logout
    async function handleLogout() {
      try {
        const token = localStorage.getItem('session_token');
        if (token) {
          await fetch(window.PUBLIC_BASE_API_URL + '/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
        }

        localStorage.removeItem('session_token');
        window.location.href = '/';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }

    // Handle dev user switching
    async function switchToDevUser(userId) {
      const devUser = devTestUsers[userId];
      if (!devUser) return;

      console.log('üîÑ Switching to dev user:', userId, 'with ageGroup:', devUser.ageGroup);

      try {
        // Get a dev session token from the backend
        const response = await fetch(window.PUBLIC_BASE_API_URL + '/auth/dev-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ user: devUser })
        });

        if (response.ok) {
          const { session_token } = await response.json();

          // Store the new session token
          localStorage.setItem('session_token', session_token);

          // Update age group in localStorage
          localStorage.setItem('user_age_group', devUser.ageGroup);
          console.log('‚úÖ Set user_age_group in localStorage:', devUser.ageGroup);

          // Save age group to profile (which also saves to notes for Spirit to read)
          await fetch(window.PUBLIC_BASE_API_URL + '/api/user/profile', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + session_token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ageGroup: devUser.ageGroup })
          });

          console.log('‚úÖ Profile saved, reloading page...');
          // Reload the page to reinitialize with new user
          window.location.reload();
        } else {
          console.error('Failed to switch to dev user');
        }
      } catch (error) {
        console.error('Error switching dev user:', error);
      }
    }

    // Logout button event listener
    logoutBtn.addEventListener('click', handleLogout);

    // Dev user switcher event listener
    devUserSelect.addEventListener('change', (e) => {
      const selectedUserId = e.target.value;
      if (selectedUserId) {
        switchToDevUser(selectedUserId);
        // Reset dropdown
        e.target.value = '';
      }
    });

    // Floating Heart Icon - Draggable and Modal
    const floatingHeart = document.getElementById('floating-heart');
    const feelingModal = document.getElementById('feeling-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    let isDragging = false;
    let startX, startY, initialX, initialY;

    // Make heart draggable
    if (floatingHeart) {
      // Mouse events
      floatingHeart.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      // Touch events
      floatingHeart.addEventListener('touchstart', dragStart, { passive: false });
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('touchend', dragEnd);

      // Click to open modal (only if not dragging)
      floatingHeart.addEventListener('click', (e) => {
        if (!isDragging) {
          openModal();
        }
      });
    }

    function dragStart(e) {
      const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

      startX = clientX;
      startY = clientY;
      initialX = floatingHeart.offsetLeft;
      initialY = floatingHeart.offsetTop;
      isDragging = false;
    }

    function drag(e) {
      if (!startX || !startY) return;

      const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

      const dx = clientX - startX;
      const dy = clientY - startY;

      // Only consider it dragging if moved more than 5px
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        isDragging = true;
        if (e.type === 'touchmove') e.preventDefault();

        let newX = initialX + dx;
        let newY = initialY + dy;

        // Keep within viewport bounds
        const maxX = window.innerWidth - floatingHeart.offsetWidth;
        const maxY = window.innerHeight - floatingHeart.offsetHeight;

        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));

        floatingHeart.style.left = newX + 'px';
        floatingHeart.style.top = newY + 'px';
        floatingHeart.style.right = 'auto';
        floatingHeart.style.bottom = 'auto';
      }
    }

    function dragEnd() {
      startX = null;
      startY = null;
      setTimeout(() => { isDragging = false; }, 100);
    }

    function openModal() {
      if (!feelingModal) return;
      feelingModal.classList.remove('hidden');
    }

    function closeModal() {
      if (!feelingModal) return;
      feelingModal.classList.add('hidden');
    }

    // Close modal button
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeModal);
    }

    // Close modal when clicking outside
    if (feelingModal) {
      feelingModal.addEventListener('click', (e) => {
        if (e.target === feelingModal) {
          closeModal();
        }
      });
    }

    // Handle feeling button clicks
    document.querySelectorAll('.feeling-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const feeling = btn.getAttribute('data-feeling');
        const emoji = btn.getAttribute('data-emoji');
        if (feeling && emoji) {
          closeModal();
          // Dispatch event with feeling data
          window.dispatchEvent(new CustomEvent('feelingSelected', {
            detail: { feeling, emoji }
          }));
        }
      });
    });

    // Initialize on load
    init();
  </script>

  <style>
    #app.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Inter', sans-serif;
    }

    /* Safe area support for mobile devices with notches/home indicators */
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Modal animation */
    @keyframes scale-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-scale-in {
      animation: scale-in 0.2s ease-out;
    }
  </style>
</Layout>
